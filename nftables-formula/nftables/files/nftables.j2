{{ pillar.get('managed_by_salt_formula', '# Managed by the nftables formula') }}

{#- Write simple variables -#}
{%- for variable, contents in config.get('variables', {}).items() %}
define {{ variable }} ={{ ' ' }}
  {%- if contents is string -%}
  {{ contents }}
  {%- elif contents is iterable and contents is not mapping -%}
  {
  {%- for value in contents %}
  {{ value }},
  {%- endfor %}
}
  {%- endif -%}
{%- endfor -%}

{#- Write sets -#}
{%- for set, set_config in config.get('sets', {}).items() %}
{%- do salt.log.error(set) %}
{%- do salt.log.error(set_config) %}
set {{ set }} =
  {%- if 'type' in set_config %}
  type {{ set_config['type'] }}
  {%- endif %}
  {%- if 'flags' in set_config %}
  flags {{ set_config['flags'] if set_config['flags'] is string else ' '.join(set_config['flags']) }}
  {%- endif %}
  {%- if set_config.get('auto-merge', False) %}
  auto-merge
  {%- endif %}
  {%- if set_config.get('counter', False) %}
  counter
  {%- endif %}
  {%- if 'policy' in set_config %}
  policy {{ set_config['policy'] }}
  {%- endif %}
  {%- if 'timeout' in set_config %}
  timeout {{ set_config['timeout'] }}
  {%- endif %}
  elements = {
    {%- for element in set_config.get('elements', []) %}
    {{ element }},
    {%- endfor %}
  }
{%- endfor %}

{#- Write tables -#}
{%- for table, table_config in config.get('tables', {}).items() %}
table {{ table }} {{ table_config['type'] }} {
  {%- if 'include' in table_config %}
  include "{{ table_config['include'] }}"
  {%- endif %}
  {%- for chain, chain_config in table_config.get('chains', {}).items() %}
  chain {{ chain }} {
    {%- if 'policy' in chain_config %}
    policy {{ chain_config['policy'] }}
    {%- endif %}
    {%- if 'jump' in chain_config %}
    jump {{ chain_config['jump'] }}
    {%- endif %}
    {%- for entry in chain_config.get('rules', []) %}
    {{ entry }}
    {%- endfor %}
  }
{%- endfor %}
}
{%- endfor %}
